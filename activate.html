<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SmartContent AI - Kích hoạt tài khoản</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="css/style.css" />
    </head>

    <body class="bg-slate-900 flex items-center justify-center h-screen">
        <div class="w-full max-w-md mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold flex items-center justify-center text-white">
                    <i class="fas fa-key mr-3 text-yellow-400 text-4xl"></i>
                    <span>SmartContent AI</span>
                </h1>
            </div>

            <div class="bg-slate-800 rounded-xl shadow-lg p-8 text-center">
                <h2 class="text-2xl font-bold text-white mb-2">Kích hoạt tài khoản</h2>
                <p class="text-sm text-gray-400 mb-6">Vui lòng nhập License Key của bạn để bắt đầu sử dụng.</p>

                <form id="activation-form">
                    <input
                        type="text"
                        id="license_key"
                        name="license_key"
                        placeholder="SCAI-XXXX-XXXX-XXXX-XXXX"
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-sm text-center font-mono tracking-wider"
                        required
                    />
                    <button
                        type="submit"
                        class="w-full mt-4 flex items-center justify-center px-4 py-3 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition"
                    >
                        Kích hoạt
                    </button>
                </form>

                <p id="activation-error" class="text-center text-sm text-red-400 mt-4 h-5"></p>
                <div class="text-sm text-gray-500 mt-8 pt-6 border-t border-slate-700">
                    <p class="font-semibold mb-2">Chưa có License Key?</p>
                    <p>Vui lòng liên hệ để được hỗ trợ:</p>
                    <p class="mt-2">
                        <span class="font-medium">SĐT:</span>
                        <a href="tel:0862027770" class="text-blue-400 hover:underline">086.202.7770</a>
                    </p>
                    <p>
                        <span class="font-medium">Email:</span>
                        <a href="mailto:info@tnnt.vn" class="text-blue-400 hover:underline">info@tnnt.vn</a>
                    </p>
                    <p class="mt-4">
                        <a href="#" id="logout-btn" class="font-medium text-gray-400 hover:underline">Đăng xuất</a>
                    </p>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // **SỬA LỖI: Lấy userId từ localStorage**
                const userId =
                    localStorage.getItem("activationUserId") || localStorage.getItem("pendingActivationUserId");
                const activationForm = document.getElementById("activation-form");
                const errorP = document.getElementById("activation-error");

                // **SỬA LỖI: Kiểm tra userId thay vì token**
                if (!userId) {
                    errorP.textContent = "Không tìm thấy thông tin người dùng. Vui lòng đăng nhập lại.";
                    // Có thể thêm nút quay lại đăng nhập ở đây
                    return; // Dừng script nếu không có userId
                }

                activationForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    errorP.textContent = ""; // Xóa lỗi cũ
                    const licenseKey = document.getElementById("license_key").value;

                    try {
                        const response = await fetch("/smartcontent-app/api/activate.php", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                // **SỬA LỖI: Không cần gửi token nữa**
                                // Authorization: "Bearer " + userToken,
                            },
                            // **SỬA LỖI: Gửi userId và license_key**
                            body: JSON.stringify({ license_key: licenseKey, userId: userId }),
                        });

                        const result = await response.json();

                        if (result.success) {
                            // **SỬA LỖI: Lưu token mới và user info nhận được từ API**
                            localStorage.setItem("authToken", result.token);
                            localStorage.setItem("currentUser", JSON.stringify(result.user));
                            // Xóa các ID tạm
                            localStorage.removeItem("activationUserId");
                            localStorage.removeItem("pendingActivationUserId");
                            // Chuyển hướng đến trang chính
                            window.location.href = "articlewriter.html";
                        } else {
                            errorP.textContent = result.message || "Kích hoạt thất bại.";
                        }
                    } catch (error) {
                        console.error("Activation Error:", error);
                        errorP.textContent = "Không thể kết nối đến máy chủ.";
                    }
                });

                document.getElementById("logout-btn").addEventListener("click", (e) => {
                    e.preventDefault();
                    // Xóa hết thông tin
                    localStorage.removeItem("authToken");
                    localStorage.removeItem("currentUser");
                    localStorage.removeItem("activationUserId");
                    localStorage.removeItem("pendingActivationUserId");
                    window.location.href = "index.html";
                });
            });
        </script>
    </body>
</html>
